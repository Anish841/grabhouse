<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>House Hunt | Making your hunt easier</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
	  <link rel="stylesheet" href="./static/css/bootstrap.css">
	  <link rel="stylesheet" href="./static/css/bootstrap.min.css">
      <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>  
      <link rel="stylesheet" href="./static/css/style.css">
	<script  type='text/javascript' src='./static/js/jquery-2.1.4.min.js'></script>
	<script  type='text/javascript' src='./static/js/bootstrap.min.js'></script>
 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTgidusdYIA_44NPMETrCM5ZsE2Ufjyvo&libraries=places&callback=initMap"
        async defer></script>
</head>
<body>
   <div class="panel panel-primary" id="address_panel">       
	    <div class="panel-heading">
       <a class="navbar-brand" rel="home" onclick="Javascript:share()" href="#" title="HouseHunt">
            <img style="max-width:200px; margin-top: -7px;"
                 src="./static/logo.png">
            </a>
            <h4 align="center">House Hunt | Making your hunt easier</h4>
	    </div>
	    <div class="panel-body" align="center">
	    	<div class="row">
				    <span id="init-loc"></span>
				    <input type="text" placeholder="Enter Source Address..." onfocus="geolocate()" class="form-control" id="autocomplete">
				     <button type="submit" id="set" class="btn btn-primary">Set</button>
				     <button type="submit" id="edit" class="btn btn-primary">Edit</button>
				     <button type="submit" id="share" class="btn btn-primary">Share</button>
			</div>
			

			
			<hr/>
			
			<div class="row">
				<label class="col-md-12"> </label>
			</div>		
                
			<div class="container" id="constraint-panel">
            <form id="constraints">
				<div class="row">
					<label class="col-md-4" style="text-align:right;"><i class="fa fa-bus"> Bus stop (&lt;) </i>  </label>
					<label class="col-md-1">: </label>
					<select id="bus" class="col-md-5 input-small form-control" onchange="refine(this.value,'bus')" style="width:20%;">
							<option value="-">-</option>				
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>
				
				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4"  style="text-align:right;"><i class="fa fa-bed"> Restaurants (&lt;)  </i> </label>
					<label class="col-md-1"> : </label>
					<select id="restaurants"  class="col-md-5 input-small form-control" onchange="refine(this.value,'restaurants')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4" style="text-align:right;"> <i class="fa fa-hospital-o"> Hospitals (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="hospital"  class="col-md-5 input-small form-control" onchange="refine(this.value,'hospital')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4"  style="text-align:right;"> <i class="fa fa-medkit"> Pharmacies (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="pharmacies"  class="col-md-5 input-small form-control" onchange="refine(this.value,'pharmacies')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4"  style="text-align:right;"> <i class="fa fa-university"> Schools (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="schools"  class="col-md-5 input-small form-control" onchange="refine(this.value,'schools')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4" style="text-align:right;"><i class="fa fa-building"> Shopping Malls (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="shopping_malls"  class="col-md-5 input-small form-control" onchange="refine(this.value,'shopping_malls')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4" style="text-align:right;"> <i class="fa fa-cc-visa"> ATMs (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="ATM"  class="col-md-5 input-small form-control" onchange="refine(this.value,'ATM')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2" style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4" style="text-align:right;"> <i class="fa fa-tree"> Gardens (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="gardens"  class="col-md-5 input-small form-control" onchange="refine(this.value,'gardens')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2"  style="text-align:left;"> kms </label>
				</div>

				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				<div class="row">
					<label class="col-md-4"  style="text-align:right;"> <i class="fa fa-file-video-o"> Movie Theaters (&lt;)</i>  </label>
					<label class="col-md-1"> : </label>
					<select id="movie_theaters"  class="col-md-5 input-small form-control" onchange="refine(this.value,'movie_theaters')" style="width:20%;">
							<option value="-">-</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>				
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>				
							<option value="9">9</option>
							<option value="10">10</option>
					</select>
					<label class="col-md-2"  style="text-align:left;"> kms </label>
				</div>
				
				<div class="row">
					<label class="col-md-12"> </label>
				</div>
				
				 <div class="row">
			    		<input type="submit" value="Create Househunt Plan" class="col-md-offset-5 col-md-2 btn btn-primary" />			    	
			    </div>
			</div>
		</form>
		</div>
    </div>
<div class="col-xs-12" id="placeholder" style="height:100px;"></div>
<div class="container" id="map-panel">
	<div class="row">
		<label class="col-md-4"> Househunt has created the perfect tour for you! </label>
<button type="submit" id="constrain" class="btn btn-primary" style="display: inline-block;float:right;margin-right:10%;">Edit Constraints</button>
    </div>
	<div class="row">
		<div id="timepathMap" style="width:500px;height:380px;" class="col-md-6"></div>
		<div id="timepathdetails" class="col-md-6"></div>
    
    </div>
</div>
<div id="footer">Crafted with <span class="pink">❤</span> by IIIT-B BHKs</div>
<br /><br />
<script>
   /*
    $( "#map-panel" ).hide();
*/
    $(document).ready(function(){
        $("#edit").hide();
        $("#init-loc").hide();
        $("#constrain").hide();
        $("#share").hide();
        
        if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
			$("#share").show();
		}
    })
    
    var placeSearch, autocomplete, points,  start, end;


    //points=['12.9715987','77.5945627','19.0176147','72.8561644','15.2993265','74.123996','17.4131912','78.5266651']
    
    $("#edit").click(function(){
        $(this).hide();
        $('#init-loc').hide();
        $("#set").show();
        $("#autocomplete").show();
    });    

    $("#constrain").click(function(){
        $(this).hide();
        $( "#constraint-panel" ).slideToggle();
        $( "#placeholder" ).slideToggle();
    });

    $("#set").click(function(){
        $(this).hide();
        $('#autocomplete').hide();
        $("#init-loc").text($("#autocomplete").val());
        $("#init-loc").show();
        $("#edit").show();
        getAddress();
		console.log(points);
    });    

    var updateConstraints = function(){
        $( "#constraint-panel" ).slideToggle();
        $( "#placeholder" ).slideToggle();
        $("#constrain").show();
        event.stopPropogation();
        event.preventDefault();
    }

    $('#constraints').submit(function(event) {
        event.preventDefault();
        updateConstraints();
    });

    var share = function(){
		//Nothing to see here
	}
	
	function geolocate() {
	  if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(position) {
		  var geolocation = {
			lat: position.coords.latitude,
			lng: position.coords.longitude
		  };
		  var circle = new google.maps.Circle({
			center: geolocation,
			radius: position.coords.accuracy
		  });
		  autocomplete.setBounds(circle.getBounds());
		});
	  }
	}


var map;
var infowindow;
var flag=0;
var ans=0;
var lat=[]
var lon=[]
var url="http://grabhousehunt.herokuapp.com/getroute?"
var afterurl="";
function checkMap(lat,lon,type,rad){
	//var self=this;
  var pyrmont = {lat: lat, lng: lon};
	flag=0;
  map = new google.maps.Map(document.getElementById('map'), {
    center: pyrmont,
    zoom: 15
  });
	
  infowindow = new google.maps.InfoWindow();

  var service = new google.maps.places.PlacesService(map);
  return service.nearbySearch({
    location: pyrmont,
    radius: rad,
    types: [type]
  }, callback)
}

function callback(results, status) {
  if (status === google.maps.places.PlacesServiceStatus.OK) {
	//alert("inside 2nd");
	ans++;
	for (var i = 0; i < results.length; i++) {
      createMarker(results[i]);
	   if(results.length>=1){
		flag=1;
	}else
		flag=0;
    }
  }
 // createMarker(results[0]);
}

function createMarker(place) {
  var placeLoc = place.geometry.location;
  var marker = new google.maps.Marker({
    map: map,
    position: place.geometry.location
  });

  google.maps.event.addListener(marker, 'click', function() {
    infowindow.setContent(place.name);
    infowindow.open(map, this);
  });
}


var ansfinal="";
var anstarget=new Array();
function checkpar(){
	console.log("in checkpar")
	var query_string = {};
	var query = window.location.search.substring(1);

	var vars = query.split("&");
	if(vars.length>=2){
		afterurl=vars[1]
	}	
	var type=new Array()
	var rad=new Array();
	for(var i=0;i<vars.length;i++){
		var parname=vars[i].split("=");
		var pname=parname[0];
		var pval=parname[1];
		if(pname=='points'){
			pval=pval.split(";;;");
			for (var j=0;j<pval.length-1;j++) {
				 var latlon=pval[j].split(",");
				 lat[j]=parseFloat(latlon[0]);
				 lon[j]=parseFloat(latlon[1]);
	  		} 
		}
		if(pname=='bus'){
			document.getElementById('bus').value =pval;
			type.push("bus");
			rad.push(pval*1000);
		}
		if(pname=='restaurants'){
			document.getElementById('restaurants').value =pval;
			type.push("Restaurants");
			rad.push(pval*1000);
		}
		if(pname=='hospital'){
			document.getElementById('hospital').value =pval;
			type.push("Hospital");
			rad.push(pval*1000);
		}
		if(pname=='pharmacies'){
			document.getElementById('pharmacies').value =pval;
			type.push("Pharmacies");
			rad.push(pval*1000);
		}
		if(pname=='schools'){
			document.getElementById('schools').value =pval;
			type.push("Schools");
			rad.push(pval*1000);
		}
		if(pname=='shopping_malls'){
			document.getElementById('shopping_malls').value =pval;
			type.push("Shopping Malls");
			rad.push(pval*1000);
		}
		if(pname=='ATM'){
			document.getElementById('ATM').value =pval;
			type.push("ATM");
			rad.push(pval*1000);
		}
		if(pname=='gardens'){
			document.getElementById('gardens').value =pval;
			type.push("Gardens");
			rad.push(pval*1000);
		}
		if(pname=='movie_theaters'){
			document.getElementById('movie_theaters').value =pval;
			type.push("movie theaters");
			rad.push(pval*1000);
		}
	}

	if(type.length<=0){
		type=['bus','restaurants','hospital','pharmacies','schools','shopping Malls','ATM','gardens','movie_theaters']
	}
	if(rad.length<=0){
		rad=[5000,5000,5000,5000,5000,5000,5000,5000,5000]
	}

	var result=new Array(lat.length);
	var res;
	var resCount=new Array(lat.length);
	
	for(var i=0;i<lat.length;i++){
		resCount[i]=0;
		result[i]=new Array(type.length);
		for(var j=0;j<type.length;j++){
			//setTimeout(function(){
				var tick=function(i,j){
					return function(){

				checkMap(lat[i],lon[i],type[j],rad[j]);
				//alert("inside callback");
				if(flag==1){
					//alert("flag1")
					resCount[i]++;
				}
				result[i][j]=flag;
			//},2000);
			}
				};
				setTimeout(tick(i,j),2000)
		}
		var tflag=1;
		for(var j=0;j<type.length;j++){
			if(result[i][j]==0){
				tflag=0;
				break;
			}
		}
		
		if(tflag){
				anstarget.push(lat[i]);
				anstarget.push(lon[i]);
				//ansfinal=(lat[i]+","+lon[i]);
				 if(ansfinal==""){
					ansfinal=(lat[i]+","+lon[i]);
				}else{
					ansfinal+=(";;;"+lat[i]+","+lon[i])
			}
		}	
	}
	points = anstarget
}

function refine(val,type){	
	url+=("points="+ansfinal);		

	//url+=("&"+type+"="+val);

	var type="";

	type=document.getElementById("bus").value;
	if(type!="-"){
		url+=("&"+"bus"+"="+type);
	}
	type=document.getElementById("restaurants").value;
	if(type!="-"){
		url+=("&"+"restaurants"+"="+type);
	}
	type=document.getElementById("hospital").value;
	if(type!="-"){
		url+=("&"+"hospital"+"="+type);
	}
	type=document.getElementById("pharmacies").value;
	if(type!="-"){
		url+=("&"+"pharmacies"+"="+type);
	}
	type=document.getElementById("schools").value;
	if(type!="-"){
		url+=("&"+"schools"+"="+type);
	}
	type=document.getElementById("shopping_malls").value;
	if(type!="-"){
		url+=("&"+"shopping_malls"+"="+type);
	}
	type=document.getElementById("ATM").value;
	if(type!="-"){
		url+=("&"+"ATM"+"="+type);
	}
	type=document.getElementById("gardens").value;
	if(type!="-"){
		url+=("&"+"gardens"+"="+type);
	}
	type=document.getElementById("movie_theaters").value;
	if(type!="-"){
		url+=("&"+"movie_theaters"+"="+type);
	}

	window.location.href=url;
}

    function getAddress()
		{
			var address=encodeURI($("#init-loc").text());
			if(address == '')
			{
				alert('Source Address Cannot be empty !!!');
				return;
			}
			address.replace(' ','+');
            var xmlhttp;
			if (window.XMLHttpRequest)
			  xmlhttp=new XMLHttpRequest();
			else
			  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");			 
			xmlhttp.onreadystatechange=function()
			  {
			  if (xmlhttp.readyState==4 && xmlhttp.status==200)
			    {
			    	if(xmlhttp.responseXML.getElementsByTagName("status")[0].childNodes[0].nodeValue!="OK")
			    	{
			    		alert("Address Not found... Please try again !!!");
			    	}
			    	else
			    	{
			    		lng=xmlhttp.responseXML.getElementsByTagName("lng")[0].childNodes[0].nodeValue;
			    		lat=xmlhttp.responseXML.getElementsByTagName("lat")[0].childNodes[0].nodeValue;
                        start = new google.maps.LatLng(lat, lng)
                        end = new google.maps.LatLng(lat, lng)
                        console.log("start"+start)
                        console.log("end"+end)
                        initMap();
                    }
			    }
			  };
			xmlhttp.open("post","https://maps.googleapis.com/maps/api/geocode/xml?address="+address+"&key=AIzaSyCQixHo0KU-1sTVmx60rt6-lhiNntbATMY",true);
			xmlhttp.send();
		}

    var initMap = function(){
		  autocomplete = new google.maps.places.Autocomplete(
      /** @type {!HTMLInputElement} */(document.getElementById('autocomplete')),
      {types: ['geocode']});
      
      

      var startindex=0;

      if($("#init-loc").is(":empty")){
			checkpar();
            start = new google.maps.LatLng(points[0],points[1]);
            end = new google.maps.LatLng(points[0],points[1]);
            startindex =1;
            console.log("here")
        }
        var destination="";
        var numpoints = points.length/2
        var waypoints=[];
        for (var i=startindex;i<numpoints;i++){
            console.log(startindex);
            var newpoint={}
            newpoint.location= new google.maps.LatLng(points[2*i], points[2*i+1]);
            newpoint.stopover=true;
            waypoints.push(newpoint);
        }
   
        var center = new google.maps.LatLng(12.9715987,77.5945627);
        var directionsDisplay = new google.maps.DirectionsRenderer();
        var directionsService = new google.maps.DirectionsService();
        var map;

         var mapOptions = {
            zoom: 14,
            center: center
          }
         map = new google.maps.Map(document.getElementById("timepathMap"), mapOptions);
         directionsDisplay.setMap(map);
         $( "#timepathdetails" ).empty();
         directionsDisplay.setPanel(document.getElementById('timepathdetails'));


          var request = {
            origin:start,
            waypoints:waypoints,
            destination:end,
            optimizeWaypoints:true,
            travelMode: google.maps.TravelMode.DRIVING
          };
          directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                console.log("result"+result)
                directionsDisplay.setDirections(result);
            }
        });
        google.maps.event.trigger(map, 'resize')

    }

    </script>
</body>
</html>
